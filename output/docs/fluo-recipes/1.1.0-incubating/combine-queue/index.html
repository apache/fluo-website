<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="/css/bootstrap/3.4.1/dist/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/css/font-awesome/4.7.0/css/font-awesome.css">
    <link rel="stylesheet" href="/css/fluo.css">
    <link rel="canonical" href="https://fluo.apache.org//docs/fluo-recipes/1.1.0-incubating/combine-queue/">
    <link rel="icon" type="image/png" href="/resources/favicon.png">
    
    <title>Combine Queue Recipe | Apache Fluo</title>

    <script type="text/javascript" src="/js/jquery/3.7.1/jquery.js"></script>
    <script type="text/javascript" src="/js/bootstrap/3.3.7/dist/js/bootstrap.js"></script>
    <script type="text/javascript" src="https://www.apachecon.com/event-images/snippet.js"></script>
    <!-- Place your <script> tags here. -->

<script>window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));</script>

  </head>
  <body style="padding-top: 100px">
    <nav id="fluo-nav" class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <div class="navbar-toggle-wrapper visible-xs">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".js-navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
          </div>
          <a href="/" class="navbar-brand"><img id="fluo-img" height="40px" src="/resources/fluo-logo-dark.png" alt="Apache Fluo"></a>
        </div>
        <div class="collapse navbar-collapse js-navbar-collapse" style="margin-top: 20px">
          <ul class="navbar-nav nav">
            <li><a href="/releases/">Releases</a></li>
            <li><a href="/tour/">Tour</a></li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">Docs<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="/docs/fluo/1.2/">Fluo</a></li>
                <li><a href="/docs/fluo-recipes/1.2/">Fluo Recipes</a></li>
              </ul>
            </li>
            <li><a href="/api/">API</a></li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">Community<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="/contactus/">Contact Us</a></li>
                <li><a href="/news/">News Archive</a></li>
                <li><a href="/people/">People</a></li>
                <li><a href="/related-projects/">Related Projects</a></li>
                <li><a href="/poweredby/">Powered By</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">Contributing<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="/how-to-contribute/">How To Contribute</a></li>
                <li><a href="/release-process/">Release Process</a></li>
              </ul>
            </li>
            <li><a href="/search/">Search</a></li>
          </ul>
          <ul class="navbar-nav nav navbar-right">
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#"><img alt="Apache Software Foundation" src="https://www.apache.org/images/feather-small.png" width="70"/><span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="https://www.apache.org">Apache Homepage</a></li>
                <li><a href="https://www.apache.org/licenses/">License</a></li>
                <li><a href="https://www.apache.org/foundation/sponsorship">Sponsorship</i></a></li>
                <li><a href="https://www.apache.org/security">Security</a></li>
                <li><a href="https://www.apache.org/foundation/thanks">Thanks</a></li>
                <li><a href="https://www.apache.org/foundation/policies/conduct">Code of Conduct</a></li>
                <li><a href="https://www.apache.org/events/current-event.html">Current Event</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="row">
          <div class="col-sm-12">
            <div class="fluo-doc">

  
  <div class="alert alert-danger" role="alert">These docs are for Fluo Recipes 1.1.0-incubating which is an old version! Check out the <a href="/docs/fluo-recipes/1.2">latest docs</a>!</div>
  

  

  <header class="post-header">
    <h2 class="post-title">Combine Queue Recipe</h2>
  </header>

  <article id="page-content">
    <h2 id="background">Background</h2>

<p>When many transactions try to modify the same keys, collisions will occur.  Too many collisions
cause transactions to fail and throughput to nose dive.  For example, consider <a href="https://github.com/fluo-io/phrasecount">phrasecount</a>
which has many transactions processing documents.  Each transaction counts the phrases in a document
and then updates global phrase counts.  Since transaction attempts to update many phrases
, the probability of collisions is high.</p>

<h2 id="solution">Solution</h2>

<p>The <a href="https://static.javadoc.io/org.apache.fluo/fluo-recipes-core/1.1.0-incubating/org/apache/fluo/recipes/core/combine/CombineQueue.html">combine queue recipe</a> provides a reusable solution for updating many keys while
avoiding collisions.  The recipe also organizes updates into batches in order to improve throughput.</p>

<p>This recipes queues updates to keys for other transactions to process. In the phrase count example
transactions processing documents queue updates, but do not actually update the counts.  Below is an
example of computing phrasecounts using this recipe.</p>

<ul>
  <li>TX1 queues <code class="language-plaintext highlighter-rouge">+1</code> update  for phrase <code class="language-plaintext highlighter-rouge">we want lambdas now</code></li>
  <li>TX2 queues <code class="language-plaintext highlighter-rouge">+1</code> update  for phrase <code class="language-plaintext highlighter-rouge">we want lambdas now</code></li>
  <li>TX3 reads the updates and current value for the phrase <code class="language-plaintext highlighter-rouge">we want lambdas now</code>.  There is no current value and the updates sum to 2, so a new value of 2 is written.</li>
  <li>TX4 queues <code class="language-plaintext highlighter-rouge">+2</code> update  for phrase <code class="language-plaintext highlighter-rouge">we want lambdas now</code></li>
  <li>TX5 queues <code class="language-plaintext highlighter-rouge">-1</code> update  for phrase <code class="language-plaintext highlighter-rouge">we want lambdas now</code></li>
  <li>TX6 reads the updates and current value for the phrase <code class="language-plaintext highlighter-rouge">we want lambdas now</code>.  The current value is 2 and the updates sum to 1, so a new value of 3 is written.</li>
</ul>

<p>Transactions processing updates have the ability to make additional updates.
For example in addition to updating the current value for a phrase, the new
value could also be placed on an export queue to update an external database.</p>

<h3 id="buckets">Buckets</h3>

<p>A simple implementation of this recipe would have an update queue for each key.  However the
implementation is slightly more complex.  Each update queue is in a bucket and transactions process
all of the updates in a bucket.  This allows more efficient processing of updates for the following
reasons :</p>

<ul>
  <li>When updates are queued, notifications are made per bucket(instead of per a key).</li>
  <li>The transaction doing the update can scan the entire bucket reading updates, this avoids a seek for each key being updated.</li>
  <li>Also the transaction can request a batch lookup to get the current value of all the keys being updated.</li>
  <li>Any additional actions taken on update (like adding something to an export queue) can also be batched.</li>
  <li>Data is organized to make reading exiting values for keys in a bucket more efficient.</li>
</ul>

<p>Which bucket a key goes to is decided using hash and modulus so that multiple updates for a key go
to the same bucket.</p>

<p>The initial number of tablets to create when applying table optimizations can be controlled by
setting the buckets per tablet option when configuring a Combine Queue.  For example if you
have 20 tablet servers and 1000 buckets and want 2 tablets per tserver initially then set buckets
per tablet to 1000/(2*20)=25.</p>

<h2 id="example-use">Example Use</h2>

<p>The following code snippets show how to use this recipe for wordcount.  The first step is to
configure it before initializing Fluo.  When initializing an ID is needed.  This ID is used in two
ways.  First, the ID is used as a row prefix in the table.  Therefore nothing else should use that
row range in the table.  Second, the ID is used in generating configuration keys.</p>

<p>The following snippet shows how to configure a combine queue.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nc">FluoConfiguration</span> <span class="n">fluoConfig</span> <span class="o">=</span> <span class="o">...;</span>

    <span class="c1">// Set application properties for the combine queue.  These properties are read later by</span>
    <span class="c1">// the observers running on each worker.</span>
    <span class="nc">CombineQueue</span><span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="nc">WcObserverProvider</span><span class="o">.</span><span class="na">ID</span><span class="o">)</span>
        <span class="o">.</span><span class="na">keyType</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">valueType</span><span class="o">(</span><span class="nc">Long</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">buckets</span><span class="o">(</span><span class="mi">119</span><span class="o">).</span><span class="na">save</span><span class="o">(</span><span class="n">fluoConfig</span><span class="o">);</span>

    <span class="n">fluoConfig</span><span class="o">.</span><span class="na">setObserverProvider</span><span class="o">(</span><span class="nc">WcObserverProvider</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="c1">// initialize Fluo using fluoConfig</span>
</code></pre></div></div>

<p>Assume the following observer is triggered when a documents is updated.  It examines new
and old document content and determines changes in word counts.  These changes are pushed to a
combine queue.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DocumentObserver</span> <span class="kd">implements</span> <span class="nc">StringObserver</span> <span class="o">{</span>
  <span class="c1">// word count combine queue</span>
  <span class="kd">private</span> <span class="nc">CombineQueue</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">wccq</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Column</span> <span class="no">NEW_COL</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Column</span><span class="o">(</span><span class="s">"content"</span><span class="o">,</span> <span class="s">"new"</span><span class="o">);</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Column</span> <span class="no">CUR_COL</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Column</span><span class="o">(</span><span class="s">"content"</span><span class="o">,</span> <span class="s">"current"</span><span class="o">);</span>

  <span class="kd">public</span> <span class="nf">DocumentObserver</span><span class="o">(</span><span class="nc">CombineQueue</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">wccq</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">wccq</span> <span class="o">=</span> <span class="n">wccq</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="nc">TransactionBase</span> <span class="n">tx</span><span class="o">,</span> <span class="nc">String</span> <span class="n">row</span><span class="o">,</span> <span class="nc">Column</span> <span class="n">col</span><span class="o">)</span> <span class="o">{</span>

    <span class="nc">Preconditions</span><span class="o">.</span><span class="na">checkArgument</span><span class="o">(</span><span class="n">col</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="no">NEW_COL</span><span class="o">));</span>

    <span class="nc">String</span> <span class="n">newContent</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="na">gets</span><span class="o">(</span><span class="n">row</span><span class="o">,</span> <span class="no">NEW_COL</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">currentContent</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="na">gets</span><span class="o">(</span><span class="n">row</span><span class="o">,</span> <span class="no">CUR_COL</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>

    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">newWordCounts</span> <span class="o">=</span> <span class="n">getWordCounts</span><span class="o">(</span><span class="n">newContent</span><span class="o">);</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">currentWordCounts</span> <span class="o">=</span> <span class="n">getWordCounts</span><span class="o">(</span><span class="n">currentContent</span><span class="o">);</span>

    <span class="c1">// determine changes in word counts between old and new document content</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">changes</span> <span class="o">=</span> <span class="n">calculateChanges</span><span class="o">(</span><span class="n">newWordCounts</span><span class="o">,</span> <span class="n">currentWordCounts</span><span class="o">);</span>

    <span class="c1">// queue updates to word counts for processing by other transactions</span>
    <span class="n">wccq</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">tx</span><span class="o">,</span> <span class="n">changes</span><span class="o">);</span>

    <span class="c1">// update the current content and delete the new content</span>
    <span class="n">tx</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">row</span><span class="o">,</span> <span class="no">CUR_COL</span><span class="o">,</span> <span class="n">newContent</span><span class="o">);</span>
    <span class="n">tx</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">row</span><span class="o">,</span> <span class="no">NEW_COL</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="nf">getWordCounts</span><span class="o">(</span><span class="nc">String</span> <span class="n">doc</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// TODO extract words from doc</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="nf">calculateChanges</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">newCounts</span><span class="o">,</span>
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">currCounts</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">changes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

    <span class="c1">// guava Maps class</span>
    <span class="nc">MapDifference</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">diffs</span> <span class="o">=</span> <span class="nc">Maps</span><span class="o">.</span><span class="na">difference</span><span class="o">(</span><span class="n">currCounts</span><span class="o">,</span> <span class="n">newCounts</span><span class="o">);</span>

    <span class="c1">// compute the diffs for words that changed</span>
    <span class="n">changes</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="nc">Maps</span><span class="o">.</span><span class="na">transformValues</span><span class="o">(</span><span class="n">diffs</span><span class="o">.</span><span class="na">entriesDiffering</span><span class="o">(),</span>
        <span class="n">vDiff</span> <span class="o">-&gt;</span> <span class="n">vDiff</span><span class="o">.</span><span class="na">rightValue</span><span class="o">()</span> <span class="o">-</span> <span class="n">vDiff</span><span class="o">.</span><span class="na">leftValue</span><span class="o">()));</span>

    <span class="c1">// add all new words</span>
    <span class="n">changes</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="n">diffs</span><span class="o">.</span><span class="na">entriesOnlyOnRight</span><span class="o">());</span>

    <span class="c1">// subtract all words no longer present</span>
    <span class="n">changes</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="nc">Maps</span><span class="o">.</span><span class="na">transformValues</span><span class="o">(</span><span class="n">diffs</span><span class="o">.</span><span class="na">entriesOnlyOnLeft</span><span class="o">(),</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">l</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="o">));</span>

    <span class="k">return</span> <span class="n">changes</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>


</code></pre></div></div>

<p>Each combine queue has two extension points, a <a href="https://static.javadoc.io/org.apache.fluo/fluo-recipes-core/1.1.0-incubating/org/apache/fluo/recipes/core/combine/Combiner.html">combiner</a> and a <a href="https://static.javadoc.io/org.apache.fluo/fluo-recipes-core/1.1.0-incubating/org/apache/fluo/recipes/core/combine/ChangeObserver.html">change
observer</a>.  The combine queue configures a Fluo observer to process queued
updates.  When processing updates the two extension points are called.  The code below shows
how to use these extension points.</p>

<p>A change observer can do additional processing when a batch of key values are updated.  Below
updates are queued for export to an external database.  The export is given the new and old value
allowing it to delete the old value if needed.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WcObserverProvider</span> <span class="kd">implements</span> <span class="nc">ObserverProvider</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ID</span> <span class="o">=</span> <span class="s">"wc"</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">provide</span><span class="o">(</span><span class="nc">Registry</span> <span class="n">obsRegistry</span><span class="o">,</span> <span class="nc">Context</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>

    <span class="nc">ExportQueue</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">MyDatabaseExport</span><span class="o">&gt;</span> <span class="n">exportQ</span> <span class="o">=</span> <span class="n">createExportQueue</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>

    <span class="c1">// Create a combine queue for computing word counts.</span>
    <span class="nc">CombineQueue</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">wcMap</span> <span class="o">=</span> <span class="nc">CombineQueue</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="no">ID</span><span class="o">,</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getAppConfiguration</span><span class="o">());</span>

    <span class="c1">// Register observer that updates the Combine Queue</span>
    <span class="n">obsRegistry</span><span class="o">.</span><span class="na">forColumn</span><span class="o">(</span><span class="nc">DocumentObserver</span><span class="o">.</span><span class="na">NEW_COL</span><span class="o">,</span> <span class="no">STRONG</span><span class="o">).</span><span class="na">useObserver</span><span class="o">(</span><span class="k">new</span> <span class="nc">DocumentObserver</span><span class="o">(</span><span class="n">wcMap</span><span class="o">));</span>

    <span class="c1">// Used to join new and existing values for a key. The lambda sums all values and returns</span>
    <span class="c1">// Optional.empty() when the sum is zero. Returning Optional.empty() causes the key/value to be</span>
    <span class="c1">// deleted. Could have used the built in SummingCombiner.</span>
    <span class="nc">Combiner</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">combiner</span> <span class="o">=</span> <span class="n">input</span> <span class="o">-&gt;</span> <span class="n">input</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">reduce</span><span class="o">(</span><span class="nl">Long:</span><span class="o">:</span><span class="n">sum</span><span class="o">).</span><span class="na">filter</span><span class="o">(</span><span class="n">l</span> <span class="o">-&gt;</span> <span class="n">l</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">);</span>

    <span class="c1">// Called when the value of a key changes. The lambda exports these changes to an external</span>
    <span class="c1">// database. Make sure to read ChangeObserver's javadoc.</span>
    <span class="nc">ChangeObserver</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">changeObs</span> <span class="o">=</span> <span class="o">(</span><span class="n">tx</span><span class="o">,</span> <span class="n">changes</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="nc">Change</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">update</span> <span class="o">:</span> <span class="n">changes</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">word</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
        <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">oldVal</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="na">getOldValue</span><span class="o">();</span>
        <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">newVal</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="na">getNewValue</span><span class="o">();</span>

        <span class="c1">// Queue an export to let an external database know the word count has changed.</span>
        <span class="n">exportQ</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">tx</span><span class="o">,</span> <span class="n">word</span><span class="o">,</span> <span class="k">new</span> <span class="nc">MyDatabaseExport</span><span class="o">(</span><span class="n">oldVal</span><span class="o">,</span> <span class="n">newVal</span><span class="o">));</span>
      <span class="o">}</span>
    <span class="o">};</span>

    <span class="c1">// Register observer that handles updates to the CombineQueue. This observer will use the</span>
    <span class="c1">// combiner and valueObserver.</span>
    <span class="n">wcMap</span><span class="o">.</span><span class="na">registerObserver</span><span class="o">(</span><span class="n">obsRegistry</span><span class="o">,</span> <span class="n">combiner</span><span class="o">,</span> <span class="n">changeObs</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="guarantees">Guarantees</h2>

<p>This recipe makes two important guarantees about updates for a key when it
calls <code class="language-plaintext highlighter-rouge">process()</code> on a <a href="https://static.javadoc.io/org.apache.fluo/fluo-recipes-core/1.1.0-incubating/org/apache/fluo/recipes/core/combine/ChangeObserver.html">ChangeObserver</a>.</p>

<ul>
  <li>The new value reported for an update will be derived from combining all
updates that were committed before the transaction that’s processing updates
started.  The implementation may have to make multiple passes over queued
updates to achieve this.  In the situation where TX1 queues a <code class="language-plaintext highlighter-rouge">+1</code> and later
TX2 queues a <code class="language-plaintext highlighter-rouge">-1</code> for the same key, there is no need to worry about only seeing
the <code class="language-plaintext highlighter-rouge">-1</code> processed.  A transaction that started processing updates after TX2
committed would process both.</li>
  <li>The old value will always be what was reported as the new value in the
previous transaction that called <code class="language-plaintext highlighter-rouge">ChangeObserver.process()</code>.</li>
</ul>


  </article>

</div>

          </div>
      </div>
      <div class="row">
        <div class="col-sm-12 center-block">
          <footer>
            <hr/>
            <p>
            <a href="https://www.apache.org/foundation/contributing"><img
              src="https://www.apache.org/images/SupportApache-small.png"
              id="asf-logo" height="100" alt="Apache"/></a>
            </p>
            <p>
            Copyright &copy; 2025 <a
              href="https://www.apache.org">The&nbsp;Apache&nbsp;Software&nbsp;Foundation</a>.
            Licensed under the <a
              href="https://www.apache.org/licenses/">Apache&nbsp;License,&nbsp;Version&nbsp;2.0</a>
            </p>
            <p>
            Apache®, the names of Apache projects and their logos, and the multicolor feather
            logo are registered trademarks or trademarks of The Apache Software Foundation
            in the United States and/or other countries.
            </p>
          </footer>
        </div>
      </div>
    </div>
  </body>
</html>
