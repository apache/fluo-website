<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" integrity="sha384-h21C2fcDk/eFsW9sC9h0dhokq5pDinLNklTKoxIZRUn3+hvmgQSffLLQ4G4l2eEr" crossorigin="anonymous">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/fluo.css">
    <link rel="canonical" href="https://fluo.apache.org//docs/fluo-recipes/1.2/recipes/recording-tx">
    <link rel="icon" type="image/png" href="/resources/favicon.png">
    
    <title>Recording Transaction | Apache Fluo</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <!-- Place your <script> tags here. -->

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-55360307-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-55360307-1');
</script>

<script>window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));</script>

  </head>
  <body style="padding-top: 100px">
    <nav id="fluo-nav" class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <div class="navbar-toggle-wrapper visible-xs">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".js-navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
          </div>
          <a href="/" class="navbar-brand"><img id="fluo-img" height="40px" src="/resources/fluo-logo-dark.png" alt="Apache Fluo"></a>
        </div>
        <div class="collapse navbar-collapse js-navbar-collapse" style="margin-top: 20px">
          <ul class="navbar-nav nav">
            <li><a href="/release/">Releases</a></li>
            <li><a href="/tour/">Tour</a></li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">Docs<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="/docs/fluo/1.1.0-incubating/">Fluo</a></li>
                <li><a href="/docs/fluo-recipes/1.1.0-incubating/">Fluo Recipes</a></li>
              </ul>
            </li>
            <li><a href="/api/">API</a></li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">Community<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="/contactus/">Contact Us</a></li>
                <li><a href="/news/">News Archive</a></li>
                <li><a href="/people/">People</a></li>
                <li><a href="/related-projects/">Related Projects</a></li>
                <li><a href="/poweredby/">Powered By</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">Contributing<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="/how-to-contribute/">How To Contribute</a></li>
                <li><a href="/release-process/">Release Process</a></li>
              </ul>
            </li>
          </ul>
          <ul class="navbar-nav nav navbar-right">
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">Apache Software Foundation<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="https://www.apache.org">Apache Homepage</a></li>
                <li><a href="https://www.apache.org/licenses/LICENSE-2.0">License</a></li>
                <li><a href="https://www.apache.org/foundation/sponsorship">Sponsorship</i></a></li>
                <li><a href="https://www.apache.org/security">Security</a></li>
                <li><a href="https://www.apache.org/foundation/thanks">Thanks</a></li>
                <li><a href="https://www.apache.org/foundation/policies/conduct">Code of Conduct</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="row">
          <div class="col-sm-12">
            <div class="row">
  <div class="col-md-2">
    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true" data-spy="affix">
      <div class="panel panel-default">
      
      
      
        
          
            <div class="panel-heading" role="tab" id="headingOne">
              <h4 class="panel-title">
                <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapsegetting-started" aria-expanded="false" aria-controls="collapsegetting-started">
                  Getting started
                </a>
              </h4>
            </div>
            <div id="collapsegetting-started" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
              <div class="panel-body">
                
                
                <div class="row doc-sidebar-link"><a href="/docs/fluo-recipes/1.2/getting-started/overview">Overview</a></div>
                
              </div>
            </div>
          
        
          
        
          
        
          
        
      
        
          
        
          
        
          
            <div class="panel-heading" role="tab" id="headingOne">
              <h4 class="panel-title">
                <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapserecipes" aria-expanded="true" aria-controls="collapserecipes">
                  Recipes
                </a>
              </h4>
            </div>
            <div id="collapserecipes" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
              <div class="panel-body">
                
                
                <div class="row doc-sidebar-link"><a href="/docs/fluo-recipes/1.2/recipes/combine-queue">Combine Queue</a></div>
                
                <div class="row doc-sidebar-link"><a href="/docs/fluo-recipes/1.2/recipes/export-queue">Export Queue</a></div>
                
                <div class="row doc-sidebar-link"><a href="/docs/fluo-recipes/1.2/recipes/accumulo-export">Accumulo Export</a></div>
                
                <div class="row doc-sidebar-link"><a href="/docs/fluo-recipes/1.2/recipes/row-hasher">Row Hash Prefix</a></div>
                
                <div class="row doc-sidebar-link"><a href="/docs/fluo-recipes/1.2/recipes/recording-tx">Recording Transaction</a></div>
                
              </div>
            </div>
          
        
          
        
      
        
          
        
          
        
          
        
          
            <div class="panel-heading" role="tab" id="headingOne">
              <h4 class="panel-title">
                <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapsetools" aria-expanded="false" aria-controls="collapsetools">
                  Tools
                </a>
              </h4>
            </div>
            <div id="collapsetools" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
              <div class="panel-body">
                
                
                <div class="row doc-sidebar-link"><a href="/docs/fluo-recipes/1.2/tools/serialization">Serializing Data</a></div>
                
                <div class="row doc-sidebar-link"><a href="/docs/fluo-recipes/1.2/tools/transient">Transient Data</a></div>
                
                <div class="row doc-sidebar-link"><a href="/docs/fluo-recipes/1.2/tools/table-optimization">Table Optimization</a></div>
                
                <div class="row doc-sidebar-link"><a href="/docs/fluo-recipes/1.2/tools/spark">Spark Helper</a></div>
                
                <div class="row doc-sidebar-link"><a href="/docs/fluo-recipes/1.2/tools/testing">Testing</a></div>
                
              </div>
            </div>
          
        
      
      </div>
    </div>
  </div>
  <div class="col-md-10">
    
    <p>Fluo Recipes 1.2.0 documentation &nbsp;&gt;&gt;&nbsp; Recipes &nbsp;&gt;&gt;&nbsp; Recording Transaction</p>
    

    <div class="alert alert-danger" style="margin-bottom: 0px;" role="alert">This documentation is for a future release of Fluo! <a href="/docs/fluo/1.1.0-incubating/">View documentation for the latest release</a>.</div>

    
    <div class="row">
      <div class="col-md-10"><h1>Recording Transaction</h1></div>
      <div class="col-md-2"><a class="pull-right" style="margin-top: 25px;" href="https://github.com/apache/fluo-website/edit/master/_recipes-1-2/recipes/recording-tx.md" role="button"><i class="glyphicon glyphicon-pencil"></i> <small>Edit this page</small></a></div>
    </div>  
    
    <p>A <a href="https://static.javadoc.io/org.apache.fluo/fluo-recipes-core/1.1.0-incubating/org/apache/fluo/recipes/core/transaction/RecordingTransaction.html">RecordingTransaction</a> is an implementation of <a href="https://static.javadoc.io/org.apache.fluo/fluo-api/1.1.0-incubating/org/apache/fluo/api/client/Transaction.html">Transaction</a> that logs all transaction operations
(i.e GET, SET, or DELETE) to a <code class="highlighter-rouge">TxLog</code> object for later uses such as exporting data.  The code below
shows how a RecordingTransaction is created by wrapping a Transaction object:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">RecordingTransactionBase</span> <span class="n">rtx</span> <span class="o">=</span> <span class="n">RecordingTransactionBase</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">tx</span><span class="o">);</span>
</code></pre>
</div>

<p>A predicate function can be passed to wrap method to select which log entries to record.  The code
below only records log entries whose column family is <code class="highlighter-rouge">meta</code>:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">RecordingTransactionBase</span> <span class="n">rtx</span> <span class="o">=</span> <span class="n">RecordingTransactionBase</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">tx</span><span class="o">,</span>
                               <span class="n">le</span> <span class="o">-&gt;</span> <span class="n">le</span><span class="o">.</span><span class="na">getColumn</span><span class="o">().</span><span class="na">getFamily</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"meta"</span><span class="o">));</span>
</code></pre>
</div>

<p>After creating a <a href="https://static.javadoc.io/org.apache.fluo/fluo-recipes-core/1.1.0-incubating/org/apache/fluo/recipes/core/transaction/RecordingTransaction.html">RecordingTransaction</a>, users can use it as they would use a Transaction object.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">Bytes</span> <span class="n">value</span> <span class="o">=</span> <span class="n">rtx</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Bytes</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"r1"</span><span class="o">),</span> <span class="k">new</span> <span class="n">Column</span><span class="o">(</span><span class="s">"cf1"</span><span class="o">,</span> <span class="s">"cq1"</span><span class="o">));</span>
</code></pre>
</div>

<p>While SET or DELETE operations are always recorded to the log, GET operations are only recorded if a
value was found at the requested row/column.  Also, if a GET method returns an iterator, only the GET
operations that are retrieved from the iterator are logged.  GET operations are logged as they are
necessary if you want to determine the changes made by the transaction.</p>

<p>When you are done operating on the transaction, you can retrieve the TxLog using the following code:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">TxLog</span> <span class="n">myTxLog</span> <span class="o">=</span> <span class="n">rtx</span><span class="o">.</span><span class="na">getTxLog</span><span class="o">()</span>
</code></pre>
</div>

<p>Below is example code of how a <a href="https://static.javadoc.io/org.apache.fluo/fluo-recipes-core/1.1.0-incubating/org/apache/fluo/recipes/core/transaction/RecordingTransaction.html">RecordingTransaction</a> can be used in an observer to record all operations
performed by the transaction in a TxLog.  In this example, a GET (if data exists) and SET operation
will be logged.  This TxLog can be added to an export queue and later used to export updates from 
Fluo.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyObserver</span> <span class="kd">extends</span> <span class="n">AbstractObserver</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">TYPEL</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TypeLayer</span><span class="o">(</span><span class="k">new</span> <span class="n">StringEncoder</span><span class="o">());</span>
    
    <span class="kd">private</span> <span class="n">ExportQueue</span><span class="o">&lt;</span><span class="n">Bytes</span><span class="o">,</span> <span class="n">TxLog</span><span class="o">&gt;</span> <span class="n">exportQueue</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">TransactionBase</span> <span class="n">tx</span><span class="o">,</span> <span class="n">Bytes</span> <span class="n">row</span><span class="o">,</span> <span class="n">Column</span> <span class="n">col</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// create recording transaction (rtx)</span>
        <span class="n">RecordingTransactionBase</span> <span class="n">rtx</span> <span class="o">=</span> <span class="n">RecordingTransactionBase</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">tx</span><span class="o">);</span>
        
        <span class="c1">// use rtx to create a typed transaction &amp; perform operations</span>
        <span class="n">TypedTransactionBase</span> <span class="n">ttx</span> <span class="o">=</span> <span class="n">TYPEL</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">rtx</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ttx</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">row</span><span class="o">(</span><span class="n">row</span><span class="o">).</span><span class="na">fam</span><span class="o">(</span><span class="s">"meta"</span><span class="o">).</span><span class="na">qual</span><span class="o">(</span><span class="s">"counter1"</span><span class="o">).</span><span class="na">toInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">ttx</span><span class="o">.</span><span class="na">mutate</span><span class="o">().</span><span class="na">row</span><span class="o">(</span><span class="n">row</span><span class="o">).</span><span class="na">fam</span><span class="o">(</span><span class="s">"meta"</span><span class="o">).</span><span class="na">qual</span><span class="o">(</span><span class="s">"counter1"</span><span class="o">).</span><span class="na">set</span><span class="o">(</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span><span class="o">);</span>
        
        <span class="c1">// when finished performing operations, retrieve transaction log</span>
        <span class="n">TxLog</span> <span class="n">txLog</span> <span class="o">=</span> <span class="n">rtx</span><span class="o">.</span><span class="na">getTxLog</span><span class="o">()</span>

        <span class="c1">// add txLog to exportQueue if not empty</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">txLog</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
          <span class="c1">//do not pass rtx to exportQueue.add()</span>
          <span class="n">exportQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">tx</span><span class="o">,</span> <span class="n">row</span><span class="o">,</span> <span class="n">txLog</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>



    <div class="row" style="margin-top: 20px;">
      <div class="col-md-10"><strong>Find documentation for all Fluo releases in the <a href="/docs/">archive</strong></div>
      <div class="col-md-2"><a class="pull-right" href="https://github.com/apache/fluo-website/edit/master/_recipes-1-2/recipes/recording-tx.md" role="button"><i class="glyphicon glyphicon-pencil"></i> <small>Edit this page</small></a></div>
    </div>  
  </div>
</div>

          </div>
      </div>
      <hr>
      <div class="row footer">
        <div class="col-sm-12 text-center">
          <div class="center-block">
          <a href="https://apache.org"><img src="/resources/feather.png" alt="Apache"></a>
          Copyright &copy; 2017 The Apache Software Foundation. Licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache&nbsp;License,&nbsp;Version&nbsp;2.0</a>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
